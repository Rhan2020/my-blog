---
title: "项目架构简化：从复杂的Nginx自动化到简洁的PM2部署"
date: "2025-06-11T20:00:00.000Z"
description: "记录将复杂的nginx配置管理从CI/CD中移除，简化为专注于应用本身的部署流程的重构过程"
tags: ["devops", "cicd", "nginx", "pm2", "architecture"]
author: "Rshan"
published: true
---

# 项目架构简化：从复杂的Nginx自动化到简洁的PM2部署

## 重构背景

在解决了nginx代理问题后，我发现项目中积累了大量与nginx配置管理相关的脚本和CI/CD逻辑。这些自动化脚本虽然功能完整，但带来了以下问题：

1. **复杂性过高**：CI/CD流程中包含了大量nginx容器管理逻辑
2. **职责不清**：应用部署与基础设施配置混合在一起
3. **维护成本**：每次nginx配置变更都需要修改多个文件
4. **调试困难**：问题排查时需要在多个层面切换

## 重构目标

将项目架构从"应用+基础设施管理"简化为"纯应用部署"，实现：

- ✅ 专注于Next.js应用的构建和部署
- ✅ 简化CI/CD流程，提高可维护性
- ✅ 将nginx配置管理交给服务器端专门处理
- ✅ 减少项目文件数量，提高代码清洁度

## 重构前的项目结构

```
my-blog/
├── .github/workflows/ci.yml        # 复杂的CI/CD流程
├── nginx-site.conf                 # HTTP配置模板
├── nginx-site-ssl.conf             # HTTPS配置模板
├── my-blog.conf                     # nginx站点配置
├── server-mcp-fix.sh               # nginx自动排查脚本(156行)
├── setup-ssl.sh                    # SSL自动配置脚本
├── trigger-deploy.md               # nginx部署文档
├── trigger-fix.md                  # nginx修复文档
├── trigger.md                      # 通用触发文档
└── src/                            # Next.js应用代码
```

## 重构后的项目结构

```
my-blog/
├── .github/workflows/ci.yml        # 简化的CI/CD流程
├── src/                            # Next.js应用代码
├── posts/                          # 博客文章
├── package.json                    # 依赖管理
└── README.md                       # 项目文档
```

## 重构过程

### 第一步：分析现有CI/CD流程

重构前的 `.github/workflows/ci.yml` 包含了复杂的nginx管理逻辑：

```yaml
# 原有的复杂步骤
- name: 配置 Nginx 代理 3000 端口 (修复只读挂载问题)
  # 80+ 行的nginx容器管理代码
  
- name: MCP 自动巡检  
  # 40+ 行的nginx状态检查代码
```

这些步骤包含：
- nginx容器发现和挂载点查找
- 配置文件动态生成和写入
- 容器重启和状态验证
- 多层级的错误处理逻辑

### 第二步：识别核心功能

分析后发现，CI/CD的核心目标很简单：
1. 构建Next.js应用
2. 上传到服务器
3. 启动/重载PM2服务
4. 验证应用运行状态

nginx配置属于基础设施层面，应该与应用部署分离。

### 第三步：删除nginx相关文件

```bash
# 删除nginx配置文件
rm nginx-site.conf nginx-site-ssl.conf my-blog.conf

# 删除nginx管理脚本  
rm server-mcp-fix.sh setup-ssl.sh

# 删除nginx相关文档
rm trigger-deploy.md trigger-fix.md trigger.md
```

### 第四步：简化CI/CD流程

将复杂的nginx管理步骤简化为基本的应用状态检查：

```yaml
# 重构后的简洁流程
- name: 应用状态检查
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: 43.139.236.77
    username: ubuntu  
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script: |
      echo "==== PM2 应用状态 ===="
      pm2 list
      echo "==== 应用端口检查 ===="
      lsof -i:3000 || echo "端口 3000 未被监听"
      echo "==== 应用访问测试 ===="
      curl -I http://localhost:3000 || echo "无法访问 3000 端口"
```

## 重构效果对比

### 代码行数对比

| 文件 | 重构前 | 重构后 | 减少 |
|------|--------|--------|------|
| ci.yml | 175行 | 64行 | -111行 |
| nginx配置文件 | 5个文件 | 0个文件 | -5个文件 |
| 脚本文件 | 2个脚本(156+22行) | 0个脚本 | -178行 |
| 文档文件 | 3个文档 | 0个文档 | -3个文件 |

**总计减少**：289行代码，10个文件

### 复杂度对比

| 方面 | 重构前 | 重构后 |
|------|--------|--------|
| CI/CD步骤 | 4个复杂步骤 | 3个简单步骤 |
| 依赖关系 | 应用+nginx+Docker | 仅应用 |
| 错误排查 | 多层级调试 | 单一应用层 |
| 配置管理 | 分散在多个文件 | 集中在服务器端 |

### 维护成本对比

| 变更场景 | 重构前 | 重构后 |
|----------|--------|--------|
| 修改nginx配置 | 修改配置文件→更新CI→部署→验证 | 服务器端直接修改 |
| 应用功能更新 | 构建→nginx配置检查→部署→多层验证 | 构建→部署→应用验证 |
| 问题排查 | 应用层+代理层+容器层 | 仅应用层 |

## 架构设计原则

通过这次重构，总结出几个重要的架构设计原则：

### 1. 单一职责原则
- **CI/CD专注于应用**：只处理代码构建、测试、部署
- **服务器专注于基础设施**：nginx、SSL、域名等在服务器端管理

### 2. 分离关注点
```
应用层    ├─ Next.js应用代码
         ├─ 业务逻辑
         └─ 应用配置

基础设施层 ├─ Nginx配置  
         ├─ SSL证书
         └─ 域名解析
```

### 3. 最小复杂度
- 移除非必要的自动化
- 减少配置文件数量
- 简化部署流程

### 4. 明确边界
- CI/CD负责到PM2启动为止
- nginx配置由运维人员手动管理
- 监控和告警在应用层实现

## 最佳实践建议

### 1. 项目文件组织

```
# 推荐的简洁结构
project/
├── src/                 # 应用源码
├── .github/workflows/   # 仅包含应用部署
├── package.json         # 依赖管理
├── README.md           # 项目文档
└── docs/               # 架构文档(可选)
```

### 2. CI/CD流程设计

```yaml
# 推荐的简洁流程
1. Checkout & Setup      # 代码检出和环境准备
2. Build & Test         # 构建和测试
3. Deploy              # 部署到服务器
4. Health Check        # 应用健康检查
```

### 3. 配置管理策略

- **应用配置**：环境变量、config文件
- **基础设施配置**：服务器端独立管理
- **敏感信息**：使用Secrets管理

## 总结

这次架构简化带来了显著的收益：

1. **代码更清洁**：减少了289行代码和10个文件
2. **流程更简单**：CI/CD专注于应用部署本身
3. **维护更容易**：问题排查和配置变更都更直接
4. **职责更清晰**：应用开发与基础设施管理分离

虽然失去了一些自动化能力，但换来的是更好的可维护性和可理解性。在团队规模较小、基础设施相对稳定的情况下，这种简化是非常值得的。

**核心理念**：不是所有东西都需要自动化，适度的手动管理有时更加高效。关键是要在自动化的便利性和系统的复杂度之间找到合适的平衡点。 